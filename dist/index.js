import*as e from"../../../../popup.js";import*as t from"../../../../openai.js";import*as r from"../../../../../script.js";import*as n from"../../../../preset-manager.js";import*as o from"../../../../textgen-settings.js";var a={d:(e,t)=>{for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};(e=>{var t={};a.d(t,e)})({});const i=(e=>{var t={};return a.d(t,e),t})({chat_completion_sources:()=>t.chat_completion_sources});const s=(e=>{var t={};return a.d(t,e),t})({CONNECT_API_MAP:()=>r.CONNECT_API_MAP,extractMessageFromData:()=>r.extractMessageFromData,max_context:()=>r.max_context,name1:()=>r.name1,name2:()=>r.name2,updateMessageBlock:()=>r.updateMessageBlock});const c=(e=>{var t={};return a.d(t,e),t})({getPresetManager:()=>n.getPresetManager});const l=(e=>{var t={};return a.d(t,e),t})({getLogprobsNumber:()=>o.getLogprobsNumber,getTextGenServer:()=>o.getTextGenServer,replaceMacrosInList:()=>o.replaceMacrosInList,textgen_types:()=>o.textgen_types});function u(e){return u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u(e)}function p(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */p=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function f(e,t,r,n){var a=t&&t.prototype instanceof v?t:v,i=Object.create(a.prototype),s=new j(n||[]);return o(i,"_invoke",{value:A(e,r,s)}),i}function h(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=f;var _="suspendedStart",m="suspendedYield",d="executing",y="completed",g={};function v(){}function b(){}function x(){}var w={};l(w,i,(function(){return this}));var L=Object.getPrototypeOf,E=L&&L(L(C([])));E&&E!==r&&n.call(E,i)&&(w=E);var k=x.prototype=v.prototype=Object.create(w);function S(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function O(e,t){function r(o,a,i,s){var c=h(e[o],e,a);if("throw"!==c.type){var l=c.arg,p=l.value;return p&&"object"==u(p)&&n.call(p,"__await")?t.resolve(p.__await).then((function(e){r("next",e,i,s)}),(function(e){r("throw",e,i,s)})):t.resolve(p).then((function(e){l.value=e,i(l)}),(function(e){return r("throw",e,i,s)}))}s(c.arg)}var a;o(this,"_invoke",{value:function(e,n){function o(){return new t((function(t,o){r(e,n,t,o)}))}return a=a?a.then(o,o):o()}})}function A(t,r,n){var o=_;return function(a,i){if(o===d)throw Error("Generator is already running");if(o===y){if("throw"===a)throw i;return{value:e,done:!0}}for(n.method=a,n.arg=i;;){var s=n.delegate;if(s){var c=P(s,n);if(c){if(c===g)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===_)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=d;var l=h(t,r,n);if("normal"===l.type){if(o=n.done?y:m,l.arg===g)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(o=y,n.method="throw",n.arg=l.arg)}}}function P(t,r){var n=r.method,o=t.iterator[n];if(o===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,P(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),g;var a=h(o,t.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,g;var i=a.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,g):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,g)}function N(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function j(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(N,this),this.reset(!0)}function C(t){if(t||""===t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function r(){for(;++o<t.length;)if(n.call(t,o))return r.value=t[o],r.done=!1,r;return r.value=e,r.done=!0,r};return a.next=a}}throw new TypeError(u(t)+" is not iterable")}return b.prototype=x,o(k,"constructor",{value:x,configurable:!0}),o(x,"constructor",{value:b,configurable:!0}),b.displayName=l(x,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===b||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,l(e,c,"GeneratorFunction")),e.prototype=Object.create(k),e},t.awrap=function(e){return{__await:e}},S(O.prototype),l(O.prototype,s,(function(){return this})),t.AsyncIterator=O,t.async=function(e,r,n,o,a){void 0===a&&(a=Promise);var i=new O(f(e,r,n,o),a);return t.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},S(k),l(k,c,"Generator"),l(k,i,(function(){return this})),l(k,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=C,j.prototype={constructor:j,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(T),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function o(n,o){return s.type="throw",s.arg=t,r.next=n,o&&(r.method="next",r.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),l=n.call(i,"finallyLoc");if(c&&l){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),T(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;T(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:C(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),g}},t}function f(e,t,r,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,o)}function h(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){f(a,n,o,i,s,"next",e)}function s(e){f(a,n,o,i,s,"throw",e)}i(void 0)}))}}var _=SillyTavern.getContext();function m(e,t){return d.apply(this,arguments)}function d(){return(d=h(p().mark((function e(t,r){return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,SillyTavern.getContext().SlashCommandParser.commands.echo.callback({severity:t},r);case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function y(e){switch(e){case i.chat_completion_sources.CLAUDE:return _.chatCompletionSettings.claude_model;case i.chat_completion_sources.OPENAI:return _.chatCompletionSettings.openai_model;case i.chat_completion_sources.WINDOWAI:return _.chatCompletionSettings.windowai_model;case i.chat_completion_sources.SCALE:return"";case i.chat_completion_sources.MAKERSUITE:return _.chatCompletionSettings.google_model;case i.chat_completion_sources.OPENROUTER:return"OR_Website"!==_.chatCompletionSettings.openrouter_model?_.chatCompletionSettings.openrouter_model:null;case i.chat_completion_sources.AI21:return _.chatCompletionSettings.ai21_model;case i.chat_completion_sources.MISTRALAI:return _.chatCompletionSettings.mistralai_model;case i.chat_completion_sources.CUSTOM:return _.chatCompletionSettings.custom_model;case i.chat_completion_sources.COHERE:return _.chatCompletionSettings.cohere_model;case i.chat_completion_sources.PERPLEXITY:return _.chatCompletionSettings.perplexity_model;case i.chat_completion_sources.GROQ:return _.chatCompletionSettings.groq_model;case i.chat_completion_sources.ZEROONEAI:return _.chatCompletionSettings.zerooneai_model;case i.chat_completion_sources.BLOCKENTROPY:return _.chatCompletionSettings.blockentropy_model;case i.chat_completion_sources.NANOGPT:return _.chatCompletionSettings.nanogpt_model;case i.chat_completion_sources.DEEPSEEK:return _.chatCompletionSettings.deepseek_model;default:throw new Error("Unknown chat completion source: ".concat(_.chatCompletionSettings.chat_completion_source))}}function g(e,t){return(0,s.extractMessageFromData)(e,t)}function v(e){return(0,l.getTextGenServer)(e)}function b(e,t){var r=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}).rerenderMessage,n=void 0===r||r;(0,s.updateMessageBlock)(e,t,{rerenderMessage:n})}function x(e){return x="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},x(e)}function w(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */w=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var a=t&&t.prototype instanceof y?t:y,i=Object.create(a.prototype),s=new j(n||[]);return o(i,"_invoke",{value:A(e,r,s)}),i}function p(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var f="suspendedStart",h="suspendedYield",_="executing",m="completed",d={};function y(){}function g(){}function v(){}var b={};l(b,i,(function(){return this}));var L=Object.getPrototypeOf,E=L&&L(L(C([])));E&&E!==r&&n.call(E,i)&&(b=E);var k=v.prototype=y.prototype=Object.create(b);function S(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function O(e,t){function r(o,a,i,s){var c=p(e[o],e,a);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==x(u)&&n.call(u,"__await")?t.resolve(u.__await).then((function(e){r("next",e,i,s)}),(function(e){r("throw",e,i,s)})):t.resolve(u).then((function(e){l.value=e,i(l)}),(function(e){return r("throw",e,i,s)}))}s(c.arg)}var a;o(this,"_invoke",{value:function(e,n){function o(){return new t((function(t,o){r(e,n,t,o)}))}return a=a?a.then(o,o):o()}})}function A(t,r,n){var o=f;return function(a,i){if(o===_)throw Error("Generator is already running");if(o===m){if("throw"===a)throw i;return{value:e,done:!0}}for(n.method=a,n.arg=i;;){var s=n.delegate;if(s){var c=P(s,n);if(c){if(c===d)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=m,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=_;var l=p(t,r,n);if("normal"===l.type){if(o=n.done?m:h,l.arg===d)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(o=m,n.method="throw",n.arg=l.arg)}}}function P(t,r){var n=r.method,o=t.iterator[n];if(o===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,P(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),d;var a=p(o,t.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,d;var i=a.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,d):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,d)}function N(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function j(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(N,this),this.reset(!0)}function C(t){if(t||""===t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function r(){for(;++o<t.length;)if(n.call(t,o))return r.value=t[o],r.done=!1,r;return r.value=e,r.done=!0,r};return a.next=a}}throw new TypeError(x(t)+" is not iterable")}return g.prototype=v,o(k,"constructor",{value:v,configurable:!0}),o(v,"constructor",{value:g,configurable:!0}),g.displayName=l(v,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,l(e,c,"GeneratorFunction")),e.prototype=Object.create(k),e},t.awrap=function(e){return{__await:e}},S(O.prototype),l(O.prototype,s,(function(){return this})),t.AsyncIterator=O,t.async=function(e,r,n,o,a){void 0===a&&(a=Promise);var i=new O(u(e,r,n,o),a);return t.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},S(k),l(k,c,"Generator"),l(k,i,(function(){return this})),l(k,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=C,j.prototype={constructor:j,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(T),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function o(n,o){return s.type="throw",s.arg=t,r.next=n,o&&(r.method="next",r.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),l=n.call(i,"finallyLoc");if(c&&l){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,d):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),d},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),T(r),d}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;T(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:C(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),d}},t}function L(e,t,r,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,o)}function E(e,t){var r=_.extensionSettings.connectionManager.profiles.find((function(t){return t.id===e}));if(!r)return m("error","Could not find profile with id ".concat(e)),null;if(!r.api)return m("error","Select a connection profile that has an API"),null;if(!r.preset)return m("error","Select a connection profile that has a preset"),null;if(!_.extensionSettings.translateViaLlm.template)return m("error","Missing template, set a template in the Translate via LLM settings"),null;var n=_.extensionSettings.translate.target_language,o=$("#translation_target_language").children('option[value="'+n+'"]').text();if(!o)return m("error","Could not find target language ".concat(n)),null;var a=_.extensionSettings.translateViaLlm.template.replace(/{{prompt}}/g,t).replace(/{{language}}/g,o);console.debug(a);var i=s.CONNECT_API_MAP[r.api];if(!i)return m("error","Could not find API ".concat(r.api)),null;if("openai"!==i.selected&&"textgenerationwebui"!==i.selected)return m("error","API ".concat(r.api," is not supported")),null;var l=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return(0,c.getPresetManager)(e)}(i.selected).getPresetList(),u=structuredClone("openai"===i.selected?l.presets[l.preset_names[r.preset]]:l.presets[l.preset_names.indexOf(r.preset)]);return u?"openai"===i.selected?{body:k(i,a,u),url:"/api/backends/chat-completions/generate",type:i.selected}:{body:S(i.type,a,u,r),url:"/api/backends/text-completions/generate",type:i.selected}:(m("error","Could not find preset ".concat(r.preset)),null)}function k(e,t,r){var n=e.source||i.chat_completion_sources.OPENAI,o=n==i.chat_completion_sources.CLAUDE,a=n==i.chat_completion_sources.OPENROUTER,c=n==i.chat_completion_sources.SCALE,l=n==i.chat_completion_sources.MAKERSUITE,u=n==i.chat_completion_sources.OPENAI,p=n==i.chat_completion_sources.MISTRALAI,f=n==i.chat_completion_sources.CUSTOM,h=n==i.chat_completion_sources.COHERE,m=n==i.chat_completion_sources.PERPLEXITY,d=n==i.chat_completion_sources.GROQ,g=n==i.chat_completion_sources.ZEROONEAI,v=n==i.chat_completion_sources.DEEPSEEK,b={};return b={messages:[{role:"system",content:t}],model:y(n),temperature:r.temperature,frequency_penalty:r.freq_pen,presence_penalty:r.pres_pen,top_p:r.top_p,max_tokens:r.openai_max_tokens,stream:!1,stop:[],chat_completion_source:n,n:r.n>1&&u?r.n:void 0,user_name:s.name1,char_name:s.name2,group_names:[],include_reasoning:!1,reasoning_effort:"medium"},r.reverse_proxy&&[i.chat_completion_sources.CLAUDE,i.chat_completion_sources.OPENAI,i.chat_completion_sources.MISTRALAI,i.chat_completion_sources.MAKERSUITE,i.chat_completion_sources.DEEPSEEK].includes(n)&&(b.reverse_proxy=r.reverse_proxy,b.proxy_password=r.proxy_password),_.powerUserSettings.request_token_probabilities&&(u||f||v)&&(b.logprobs=5),o&&(b.top_k=Number(r.top_k),b.claude_use_sysprompt=r.claude_use_sysprompt),a&&(b.top_k=Number(r.top_k),b.min_p=Number(r.min_p),b.repetition_penalty=Number(r.repetition_penalty),b.top_a=Number(r.top_a),b.use_fallback=r.openrouter_use_fallback,b.provider=r.openrouter_providers,b.allow_fallbacks=r.openrouter_allow_fallbacks,b.middleout=r.openrouter_middleout),c&&(b.api_url_scale=r.api_url_scale),l&&(b.top_k=Number(r.top_k),b.use_makersuite_sysprompt=r.use_makersuite_sysprompt),p&&(b.safe_prompt=!1),f&&(b.custom_url=r.custom_url,b.custom_include_body=r.custom_include_body,b.custom_exclude_body=r.custom_exclude_body,b.custom_include_headers=r.custom_include_headers,b.custom_prompt_post_processing=r.custom_prompt_post_processing),h&&(b.top_p=Math.min(Math.max(Number(r.top_p),.01),.99),b.top_k=Number(r.top_k),b.frequency_penalty=Math.min(Math.max(Number(r.freq_pen),0),1),b.presence_penalty=Math.min(Math.max(Number(r.pres_pen),0),1)),m&&(b.top_k=Number(r.top_k),b.frequency_penalty=Math.max(0,Number(r.freq_pen))+1,b.presence_penalty=Number(r.pres_pen),delete b.stop),d&&(delete b.logprobs,delete b.logit_bias,delete b.top_logprobs,delete b.n),g&&(delete b.logprobs,delete b.logit_bias,delete b.top_logprobs,delete b.n,delete b.frequency_penalty,delete b.presence_penalty,delete b.stop),v&&(b.top_p=b.top_p||Number.EPSILON,b.model.endsWith("-reasoner")&&(delete b.top_p,delete b.temperature,delete b.frequency_penalty,delete b.presence_penalty,delete b.top_logprobs,delete b.logprobs,delete b.logit_bias,delete b.tools,delete b.tool_choice)),u&&(r.openai_model.startsWith("o1")||r.openai_model.startsWith("o3"))&&(b.messages.forEach((function(e){"system"===e.role&&(e.role="user")})),b.max_completion_tokens=b.max_tokens,delete b.max_tokens,delete b.logprobs,delete b.top_logprobs,delete b.n,delete b.temperature,delete b.top_p,delete b.frequency_penalty,delete b.presence_penalty,delete b.tools,delete b.tool_choice,delete b.stop,delete b.logit_bias),b}function S(e,t,r,n){var o;if(!n.model)return m("error","Select a connection profile that has a model"),null;if(!e)return m("error","Select a connection profile that has a type"),null;var a,i,c=null===(o=document.getElementById("dynatemp_block_ooba"))||void 0===o||null===(o=o.dataset)||void 0===o||null===(o=o.tgType)||void 0===o?void 0:o.includes(e);a={stream:!1,prompt:t,model:n.model,max_new_tokens:0,max_tokens:0,logprobs:_.powerUserSettings.request_token_probabilities?(0,l.getLogprobsNumber)():void 0,temperature:c?(r.min_temp+r.max_temp)/2:r.temp,top_p:r.top_p,typical_p:r.typical_p,typical:r.typical_p,sampler_seed:r.seed>=0?r.seed:void 0,min_p:r.min_p,repetition_penalty:r.rep_pen,frequency_penalty:r.freq_pen,presence_penalty:r.presence_pen,top_k:r.top_k,skew:r.skew,min_length:e===l.textgen_types.OOBA?r.min_length:void 0,minimum_message_content_tokens:e===l.textgen_types.DREAMGEN?r.min_length:void 0,min_tokens:r.min_length,num_beams:e===l.textgen_types.OOBA?r.num_beams:void 0,length_penalty:e===l.textgen_types.OOBA?r.length_penalty:void 0,early_stopping:e===l.textgen_types.OOBA?r.early_stopping:void 0,add_bos_token:r.add_bos_token,dynamic_temperature:!!c||void 0,dynatemp_low:c?r.min_temp:void 0,dynatemp_high:c?r.max_temp:void 0,dynatemp_range:c?(r.max_temp-r.min_temp)/2:void 0,dynatemp_exponent:c?r.dynatemp_exponent:void 0,smoothing_factor:r.smoothing_factor,smoothing_curve:r.smoothing_curve,dry_allowed_length:r.dry_allowed_length,dry_multiplier:r.dry_multiplier,dry_base:r.dry_base,dry_sequence_breakers:(i=r.dry_sequence_breakers,(0,l.replaceMacrosInList)(i)),dry_penalty_last_n:r.dry_penalty_last_n,max_tokens_second:r.max_tokens_second,sampler_priority:e===l.textgen_types.OOBA?r.sampler_priority:void 0,samplers:e===l.textgen_types.LLAMACPP?r.samplers:void 0,stopping_strings:[],stop:[],truncation_length:s.max_context,ban_eos_token:r.ban_eos_token,skip_special_tokens:r.skip_special_tokens,include_reasoning:r.include_reasoning,top_a:r.top_a,tfs:r.tfs,epsilon_cutoff:[l.textgen_types.OOBA,l.textgen_types.MANCER].includes(e)?r.epsilon_cutoff:void 0,eta_cutoff:[l.textgen_types.OOBA,l.textgen_types.MANCER].includes(e)?r.eta_cutoff:void 0,mirostat_mode:r.mirostat_mode,mirostat_tau:r.mirostat_tau,mirostat_eta:r.mirostat_eta,custom_token_bans:[],banned_strings:[],api_type:e,api_server:v(e),sampler_order:e===l.textgen_types.KOBOLDCPP?r.sampler_order:void 0,xtc_threshold:r.xtc_threshold,xtc_probability:r.xtc_probability,nsigma:r.nsigma};var u={rep_pen:r.rep_pen,rep_pen_range:r.rep_pen_range,repetition_decay:e===l.textgen_types.TABBY?r.rep_pen_decay:void 0,repetition_penalty_range:r.rep_pen_range,encoder_repetition_penalty:e===l.textgen_types.OOBA?r.encoder_rep_pen:void 0,no_repeat_ngram_size:e===l.textgen_types.OOBA?r.no_repeat_ngram_size:void 0,penalty_alpha:e===l.textgen_types.OOBA?r.penalty_alpha:void 0,temperature_last:e===l.textgen_types.OOBA||e===l.textgen_types.APHRODITE||e==l.textgen_types.TABBY?r.temperature_last:void 0,speculative_ngram:e===l.textgen_types.TABBY?r.speculative_ngram:void 0,do_sample:e===l.textgen_types.OOBA?r.do_sample:void 0,seed:r.seed>=0?r.seed:void 0,guidance_scale:1,negative_prompt:"",grammar_string:r.grammar_string,json_schema:[l.textgen_types.TABBY,l.textgen_types.LLAMACPP].includes(e)?r.json_schema:void 0,repeat_penalty:r.rep_pen,tfs_z:r.tfs,repeat_last_n:r.rep_pen_range,n_predict:0,num_predict:0,num_ctx:s.max_context,mirostat:r.mirostat_mode,ignore_eos:r.ban_eos_token,n_probs:_.powerUserSettings.request_token_probabilities?10:void 0,rep_pen_slope:r.rep_pen_slope},p={n:r.n,ignore_eos:r.ignore_eos_token,spaces_between_special_tokens:r.spaces_between_special_tokens,seed:r.seed>=0?r.seed:void 0},f={n:r.n,frequency_penalty:r.freq_pen,presence_penalty:r.presence_pen,repetition_penalty:r.rep_pen,seed:r.seed>=0?r.seed:void 0,stop:[],temperature:c?(r.min_temp+r.max_temp)/2:r.temp,temperature_last:r.temperature_last,top_p:r.top_p,top_k:r.top_k,top_a:r.top_a,min_p:r.min_p,tfs:r.tfs,eta_cutoff:r.eta_cutoff,epsilon_cutoff:r.epsilon_cutoff,typical_p:r.typical_p,smoothing_factor:r.smoothing_factor,smoothing_curve:r.smoothing_curve,ignore_eos:r.ignore_eos_token,min_tokens:r.min_length,skip_special_tokens:r.skip_special_tokens,spaces_between_special_tokens:r.spaces_between_special_tokens,guided_grammar:r.grammar_string,guided_json:r.json_schema,early_stopping:!1,include_stop_str_in_output:!1,dynatemp_min:c?r.min_temp:void 0,dynatemp_max:c?r.max_temp:void 0,dynatemp_exponent:c?r.dynatemp_exponent:void 0,xtc_threshold:r.xtc_threshold,xtc_probability:r.xtc_probability,nsigma:r.nsigma,custom_token_bans:[],no_repeat_ngram_size:r.no_repeat_ngram_size,sampler_priority:void 0};switch(e===l.textgen_types.OPENROUTER&&(a.provider=r.openrouter_providers,a.allow_fallbacks=r.openrouter_allow_fallbacks),e===l.textgen_types.KOBOLDCPP&&(a.grammar=r.grammar_string,a.trim_stop=!0),e===l.textgen_types.HUGGINGFACE&&(a.top_p=Math.min(Math.max(Number(a.top_p),0),.999),a.stop=Array.isArray(a.stop)?a.stop.slice(0,4):[],u.seed=r.seed>=0?r.seed:Math.floor(Math.random()*Math.pow(2,32))),e===l.textgen_types.MANCER&&(a.n=r.n,a.epsilon_cutoff/=1e3,a.eta_cutoff/=1e3,a.dynatemp_mode=a.dynamic_temperature?1:0,a.dynatemp_min=a.dynatemp_low,a.dynatemp_max=a.dynatemp_high,delete a.dynatemp_low,delete a.dynatemp_high),e===l.textgen_types.TABBY&&(a.n=r.n),e){case l.textgen_types.VLLM:case l.textgen_types.INFERMATICAI:a=Object.assign(a,p);break;case l.textgen_types.APHRODITE:a=Object.assign(a,f);break;default:a=Object.assign(a,u)}return e===l.textgen_types.LLAMACPP&&(a.json_schema&&Object.keys(a.json_schema).length>0?(delete a.grammar_string,delete a.grammar):delete a.json_schema),a}function O(e,t,r){return A.apply(this,arguments)}function A(){var e;return e=w().mark((function e(t,r,n){var o,a,i;return w().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch(r,{method:"POST",body:JSON.stringify(t),headers:_.getRequestHeaders(),cache:"no-cache",signal:(new AbortController).signal});case 2:if((o=e.sent).ok){e.next=5;break}throw new Error("Got response status ".concat(o.status));case 5:return e.next=7,o.json();case 7:if(!(a=e.sent).error){e.next=12;break}throw m("error",i=a.error.message||o.statusText||"Unknown error"),new Error(i);case 12:return e.abrupt("return",g(a,n));case 13:case"end":return e.stop()}}),e)})),A=function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){L(a,n,o,i,s,"next",e)}function s(e){L(a,n,o,i,s,"throw",e)}i(void 0)}))},A.apply(this,arguments)}function P(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */P=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var a=t&&t.prototype instanceof y?t:y,i=Object.create(a.prototype),s=new j(n||[]);return o(i,"_invoke",{value:S(e,r,s)}),i}function p(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var f="suspendedStart",h="suspendedYield",_="executing",m="completed",d={};function y(){}function g(){}function v(){}var b={};l(b,i,(function(){return this}));var x=Object.getPrototypeOf,w=x&&x(x(C([])));w&&w!==r&&n.call(w,i)&&(b=w);var L=v.prototype=y.prototype=Object.create(b);function E(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function r(o,a,i,s){var c=p(e[o],e,a);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==N(u)&&n.call(u,"__await")?t.resolve(u.__await).then((function(e){r("next",e,i,s)}),(function(e){r("throw",e,i,s)})):t.resolve(u).then((function(e){l.value=e,i(l)}),(function(e){return r("throw",e,i,s)}))}s(c.arg)}var a;o(this,"_invoke",{value:function(e,n){function o(){return new t((function(t,o){r(e,n,t,o)}))}return a=a?a.then(o,o):o()}})}function S(t,r,n){var o=f;return function(a,i){if(o===_)throw Error("Generator is already running");if(o===m){if("throw"===a)throw i;return{value:e,done:!0}}for(n.method=a,n.arg=i;;){var s=n.delegate;if(s){var c=O(s,n);if(c){if(c===d)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=m,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=_;var l=p(t,r,n);if("normal"===l.type){if(o=n.done?m:h,l.arg===d)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(o=m,n.method="throw",n.arg=l.arg)}}}function O(t,r){var n=r.method,o=t.iterator[n];if(o===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,O(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),d;var a=p(o,t.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,d;var i=a.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,d):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,d)}function A(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function j(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(A,this),this.reset(!0)}function C(t){if(t||""===t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function r(){for(;++o<t.length;)if(n.call(t,o))return r.value=t[o],r.done=!1,r;return r.value=e,r.done=!0,r};return a.next=a}}throw new TypeError(N(t)+" is not iterable")}return g.prototype=v,o(L,"constructor",{value:v,configurable:!0}),o(v,"constructor",{value:g,configurable:!0}),g.displayName=l(v,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,l(e,c,"GeneratorFunction")),e.prototype=Object.create(L),e},t.awrap=function(e){return{__await:e}},E(k.prototype),l(k.prototype,s,(function(){return this})),t.AsyncIterator=k,t.async=function(e,r,n,o,a){void 0===a&&(a=Promise);var i=new k(u(e,r,n,o),a);return t.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},E(L),l(L,c,"Generator"),l(L,i,(function(){return this})),l(L,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=C,j.prototype={constructor:j,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(T),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function o(n,o){return s.type="throw",s.arg=t,r.next=n,o&&(r.method="next",r.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),l=n.call(i,"finallyLoc");if(c&&l){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,d):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),d},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),T(r),d}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;T(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:C(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),d}},t}function N(e){return N="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},N(e)}function T(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return j(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?j(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,a=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw a}}}}function j(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function C(e,t,r,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,o)}function M(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){C(a,n,o,i,s,"next",e)}function s(e){C(a,n,o,i,s,"throw",e)}i(void 0)}))}}var I="Translate this text to {{language}}. You must format your response as a code block using triple backticks. Only include the translated text inside the code block, without any additional text:\n\n```\n{{prompt}}\n```\n\nImportant: Your response must follow this exact format with the translation enclosed in code blocks (```).";function B(){return(B=M(P().mark((function e(){var t,r,n,o,a,i,s,c;return P().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(_.extensionSettings.connectionManager){e.next=3;break}return m("error","Connection Manager is required to use Translate via LLM"),e.abrupt("return");case 3:if(_.extensionSettings.translate){e.next=6;break}return m("error","Translate is required to use Translate via LLM"),e.abrupt("return");case 6:return _.extensionSettings.translateViaLlm||(_.extensionSettings.translateViaLlm={}),void 0===_.extensionSettings.translateViaLlm.selectedProfile&&(_.extensionSettings.translateViaLlm.selectedProfile=""),void 0===_.extensionSettings.translateViaLlm.template&&(_.extensionSettings.translateViaLlm.template=I),void 0===_.extensionSettings.translateViaLlm.filterCodeBlock&&(_.extensionSettings.translateViaLlm.filterCodeBlock=!0),e.next=12,_.renderExtensionTemplateAsync("third-party/".concat("SillyTavern-LLM-Translator"),"templates/settings");case 12:t=e.sent,$("#extensions_settings").append(t),r=$(".translate-via-llm-settings"),n=r.find(".profile"),o=!1,r.find(".inline-drawer-toggle").on("click",(function(){o=!0;var e=n.find('option[value=""]');n.empty().append(e);var t,r=T(_.extensionSettings.connectionManager.profiles);try{for(r.s();!(t=r.n()).done;){var a=t.value,i=$("<option></option>");i.attr("value",a.id),i.text(a.name||a.id),i.prop("selected",a.id===_.extensionSettings.translateViaLlm.selectedProfile),n.append(i)}}catch(e){r.e(e)}finally{r.f()}o=!1})),n.on("change",(function(){if(!o){var e=n.val();e!==_.extensionSettings.translateViaLlm.selectedProfile&&(_.extensionSettings.translateViaLlm.selectedProfile=e,_.saveSettingsDebounced())}})),(a=r.find(".prompt")).val(_.extensionSettings.translateViaLlm.template),a.on("change",(function(){var e=a.val();e!==_.extensionSettings.translateViaLlm.template&&(_.extensionSettings.translateViaLlm.template=e,_.saveSettingsDebounced())})),(i=r.find(".filter_code_block")).prop("checked",_.extensionSettings.translateViaLlm.filterCodeBlock),i.on("change",(function(){var e=i.prop("checked");_.extensionSettings.translateViaLlm.filterCodeBlock=e,_.saveSettingsDebounced()})),r.find(".restore_default").on("click",(function(){a.val(I),a.trigger("change")})),s=$('<div title="Translate via LLM" class="mes_button mes_translate_via_llm_button fa-solid fa-globe interactable" tabindex="0"></div>'),$("#message_template .mes_buttons .extraMesButtons").prepend(s),c=!1,$(document).on("click",".mes_translate_via_llm_button",M(P().mark((function e(){var t,r,n,o,a,i,s,l;return P().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!c){e.next=3;break}return m("error","Translation is already in progress"),e.abrupt("return");case 3:if(c=!0,e.prev=4,r=$(this).closest(".mes"),n=Number(r.attr("mesid")),o=_.chat[n]){e.next=11;break}return m("error","Could not find message with id ".concat(n)),e.abrupt("return");case 11:if(null==o||null===(t=o.extra)||void 0===t||!t.display_text){e.next=15;break}return delete o.extra.display_text,b(n,o),e.abrupt("return");case 15:if(_.extensionSettings.translateViaLlm.selectedProfile){e.next=18;break}return m("error","Select a connection profile"),e.abrupt("return");case 18:if(a=E(_.extensionSettings.translateViaLlm.selectedProfile,o.mes)){e.next=21;break}return e.abrupt("return");case 21:return console.debug(a),e.next=24,O(a.body,a.url,a.type);case 24:i=e.sent,console.debug(i),"object"!==N(o.extra)&&(o.extra={}),s=i,_.extensionSettings.translateViaLlm.filterCodeBlock&&(l=i.match(/^(?:[^`]*?)\n?```[\s\S]*?\n([\s\S]*?)```(?![^`]*```)/))&&(s=l[1].trim()),o.extra.display_text=s,b(n,o),e.next=36;break;case 33:e.prev=33,e.t0=e.catch(4),console.error(e.t0);case 36:return e.prev=36,c=!1,e.finish(36);case 39:case"end":return e.stop()}}),e,this,[[4,33,36,39]])}))));case 30:case"end":return e.stop()}}),e)})))).apply(this,arguments)}!function(){B.apply(this,arguments)}();